<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peeno - Stripe Connect Redirect</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #FDF5E6;
            color: #333;
        }
        
        .container {
            max-width: 500px;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px;
        }
        
        h1 {
            color: #FF7A00;
            margin-bottom: 20px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #FF7A00;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        p {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        #debug {
            font-size: 12px;
            color: #666;
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reindirizzamento in corso</h1>
        <div class="spinner"></div>
        <p id="message">Attendi mentre ti reindirizziamo all'app Peeno...</p>
        <p id="debug"></p>
        
        <script>
            // Funzione per loggare messaggi di debug
            function logDebug(message) {
                const debug = document.getElementById('debug');
                debug.innerHTML += message + '<br>';
            }
            
            // Funzione per ottenere i parametri dall'URL
            function getParams() {
                let params = {};
                let queryString = window.location.search.substring(1);
                let pairs = queryString.split('&');
                
                for (let pair of pairs) {
                    if (pair === '') continue;
                    let parts = pair.split('=');
                    params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
                }
                
                return params;
            }
            
            // Log dell'URL corrente
            logDebug('URL corrente: ' + window.location.href);
            
            // Ottieni i parametri
            const params = getParams();
            logDebug('Parametri ricevuti: ' + JSON.stringify(params));
            
            // Verifica se abbiamo gli elementi principali nel path
            const path = window.location.pathname;
            logDebug('Path: ' + path);
            
            // Determina il tipo di redirect
            function determineRedirect() {
                const messageElement = document.getElementById('message');
                let redirectUrl;
                
                // Se ci sono errori
                if (params.error) {
                    messageElement.textContent = 'Si è verificato un errore. Verrai reindirizzato...';
                    redirectUrl = 'https://fooddeliveryapp-bfa07.firebaseapp.com/rider/verify-bank-account?error=verification_error';
                    logDebug('Tipo di redirect: Errore');
                } 
                // Se abbiamo un account ID (successo)
                else if (params.accountId || params.account) {
                    messageElement.textContent = 'Verifica completata con successo. Verrai reindirizzato...';
                    redirectUrl = 'https://fooddeliveryapp-bfa07.firebaseapp.com/rider/become-rider?step=2&stripe_verified=true';
                    logDebug('Tipo di redirect: Successo');
                } 
                // Stato incompleto
                else {
                    messageElement.textContent = 'Verifica incompleta. Verrai reindirizzato...';
                    redirectUrl = 'https://fooddeliveryapp-bfa07.firebaseapp.com/rider/become-rider?step=2&stripe_status=incomplete';
                    logDebug('Tipo di redirect: Incompleto');
                }
                
                // Aggiungi tutti i parametri originali all'URL di redirect
                for (const key in params) {
                    // Evita di aggiungere parametri già presenti nel nuovo URL
                    if (key !== 'step' && key !== 'stripe_verified' && key !== 'stripe_status' && key !== 'error') {
                        if (redirectUrl.includes('?')) {
                            redirectUrl += '&' + key + '=' + params[key];
                        } else {
                            redirectUrl += '?' + key + '=' + params[key];
                        }
                    }
                }
                
                logDebug('URL di redirect: ' + redirectUrl);
                
                // Esegui il redirect
                setTimeout(function() {
                    window.location.href = redirectUrl;
                }, 2000);
            }
            
            // Esegui il redirect dopo un breve ritardo
            determineRedirect();
        </script>
    </div>
</body>
</html>