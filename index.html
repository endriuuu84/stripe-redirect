<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peeno - Stripe Connect Redirect</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #FDF5E6;
            color: #333;
        }
        
        .container {
            max-width: 500px;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px;
        }
        
        h1 {
            color: #FF7A00;
            margin-bottom: 20px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #FF7A00;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        p {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        #debug {
            font-size: 12px;
            color: #666;
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            text-align: left;
            overflow-wrap: break-word;
        }
        
        .logo {
            width: 120px;
            height: auto;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://firebasestorage.googleapis.com/v0/b/fooddeliveryapp-bfa07.appspot.com/o/peeno-logo.png?alt=media" alt="Peeno Logo" class="logo" onerror="this.style.display='none'">
        <h1>Reindirizzamento in corso</h1>
        <div class="spinner"></div>
        <p id="message">Attendi mentre ti reindirizziamo all'app Peeno...</p>
        <p id="debug"></p>
        
        <script>
            // Funzione per loggare messaggi di debug
            function logDebug(message) {
                const debug = document.getElementById('debug');
                debug.innerHTML += message + '<br>';
            }
            
            // Funzione per ottenere i parametri dall'URL
            function getParams() {
                let params = {};
                let queryString = window.location.search.substring(1);
                let pairs = queryString.split('&');
                
                for (let pair of pairs) {
                    if (pair === '') continue;
                    let parts = pair.split('=');
                    params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
                }
                
                return params;
            }
            
            // Funzione per analizzare il parametro 'state'
            function parseStateParam(stateParam) {
                if (!stateParam) return null;
                
                try {
                    // Prima prova a interpretarlo come JSON
                    return JSON.parse(stateParam);
                } catch (e) {
                    try {
                        // Se non è JSON, prova come URL params
                        const result = {};
                        stateParam.split('&').forEach(pair => {
                            const [key, value] = pair.split('=');
                            if (key && value) result[key] = decodeURIComponent(value);
                        });
                        return Object.keys(result).length > 0 ? result : null;
                    } catch (e2) {
                        logDebug('Errore parsing state: ' + e2.message);
                        return null;
                    }
                }
            }
            
            // Log dell'URL corrente
            logDebug('URL corrente: ' + window.location.href);
            
            // Ottieni i parametri
            const params = getParams();
            logDebug('Parametri ricevuti: ' + JSON.stringify(params));
            
            // Verifica se abbiamo gli elementi principali nel path
            const path = window.location.pathname;
            logDebug('Path: ' + path);
            
            // Determina il tipo di redirect
            function determineRedirect() {
                const messageElement = document.getElementById('message');
                let redirectUrl;
                
                // Prepara variabili per i parametri importanti
                let hasAccountId = false;
                let accountId = '';
                let userId = '';
                
                // Cerca accountId in diversi posti possibili
                if (params.accountId) {
                    hasAccountId = true;
                    accountId = params.accountId;
                    logDebug('AccountId trovato nel parametro accountId: ' + accountId);
                } else if (params.account) {
                    hasAccountId = true;
                    accountId = params.account;
                    logDebug('AccountId trovato nel parametro account: ' + accountId);
                } else if (params.account_id) {
                    hasAccountId = true;
                    accountId = params.account_id;
                    logDebug('AccountId trovato nel parametro account_id: ' + accountId);
                }
                
                // Cerca userId
                if (params.userId) {
                    userId = params.userId;
                    logDebug('UserId trovato nel parametro userId: ' + userId);
                } else if (params.user_id) {
                    userId = params.user_id;
                    logDebug('UserId trovato nel parametro user_id: ' + userId);
                }
                
                // Controlla il parametro state per informazioni aggiuntive
                if (params.state && !hasAccountId) {
                    const stateData = parseStateParam(params.state);
                    logDebug('State param: ' + JSON.stringify(stateData));
                    
                    if (stateData) {
                        if (stateData.accountId || stateData.account_id) {
                            hasAccountId = true;
                            accountId = stateData.accountId || stateData.account_id;
                            logDebug('AccountId trovato nel parametro state: ' + accountId);
                        }
                        
                        if (stateData.userId || stateData.user_id) {
                            userId = stateData.userId || stateData.user_id;
                            logDebug('UserId trovato nel parametro state: ' + userId);
                        }
                    }
                }
                
                // Determina il tipo di redirect in base ai parametri
                if (params.error) {
                    messageElement.textContent = 'Si è verificato un errore. Verrai reindirizzato...';
                    redirectUrl = 'https://fooddeliveryapp-bfa07.firebaseapp.com/rider/verify-bank-account?error=verification_error';
                    logDebug('Tipo di redirect: Errore - ' + params.error);
                    
                    // Aggiungi descrizione errore se disponibile
                    if (params.error_description) {
                        redirectUrl += '&error_description=' + encodeURIComponent(params.error_description);
                    }
                } 
                // Se abbiamo un account ID (successo)
                else if (hasAccountId) {
                    messageElement.textContent = 'Verifica completata con successo. Verrai reindirizzato...';
                    redirectUrl = 'https://fooddeliveryapp-bfa07.firebaseapp.com/rider/become-rider?step=2&stripe_verified=true';
                    
                    // Aggiungi accountId e userId al redirect
                    redirectUrl += '&accountId=' + encodeURIComponent(accountId);
                    if (userId) {
                        redirectUrl += '&userId=' + encodeURIComponent(userId);
                    }
                    
                    logDebug('Tipo di redirect: Successo con accountId: ' + accountId);
                } 
                // Stato incompleto
                else {
                    messageElement.textContent = 'Verifica incompleta. Verrai reindirizzato...';
                    redirectUrl = 'https://fooddeliveryapp-bfa07.firebaseapp.com/rider/become-rider?step=2&stripe_status=incomplete';
                    logDebug('Tipo di redirect: Incompleto (accountId non trovato)');
                }
                
                // Aggiungi timestamp al redirect per evitare problemi di cache
                redirectUrl += '&_t=' + Date.now();
                
                logDebug('URL di redirect finale: ' + redirectUrl);
                
                // Esegui il redirect
                setTimeout(function() {
                    window.location.href = redirectUrl;
                }, 2000);
            }
            
            // Esegui il redirect dopo un breve ritardo
            determineRedirect();
        </script>
    </div>
</body>
</html>